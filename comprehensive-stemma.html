<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Gregory of Tours Manuscript Stemma - MGH Edition</title>
    <script src="https://unpkg.com/d3@7"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
        }

        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .content {
            flex: 1;
            display: flex;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #dee2e6;
            padding: 1rem;
            overflow-y: auto;
        }

        .main {
            flex: 1;
            position: relative;
            background: #fafafa;
        }

        .controls h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .family-section {
            margin-bottom: 1.5rem;
        }

        .family-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .family-button {
            flex: 1;
            padding: 0.7rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 6px;
            text-align: left;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }

        .family-button.expanded {
            background: var(--family-color, #3498db);
            color: white;
            border-color: var(--family-color, #3498db);
        }

        .family-button:hover {
            border-color: var(--family-color, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .family-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.3rem;
            font-style: italic;
        }

        .family-button.expanded .family-info {
            color: rgba(255,255,255,0.8);
        }

        .manuscript-count {
            background: rgba(0,0,0,0.1);
            color: #666;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .family-button.expanded .manuscript-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .legend {
            margin-top: 2rem;
        }

        .legend h4 {
            color: #34495e;
            margin-bottom: 0.8rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0.6rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #ccc;
        }

        .node-info {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 350px;
            max-height: 70vh;
            overflow-y: auto;
            display: none;
            border: 1px solid #e0e6ed;
        }

        .node-info h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .info-section {
            margin-bottom: 1rem;
        }

        .info-section h5 {
            color: #34495e;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-section p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.4rem;
        }

        .manuscript-list {
            display: grid;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .manuscript-item {
            background: #f8f9fa;
            padding: 0.6rem;
            border-radius: 6px;
            border-left: 3px solid var(--family-color, #3498db);
        }

        .manuscript-siglum {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.2rem;
        }

        .manuscript-details {
            color: #666;
            font-size: 0.8rem;
        }

        #stemma-svg {
            width: 100%;
            height: 100%;
            background: #fafafa;
        }

        .instructions {
            background: linear-gradient(135deg, #e8f4f8 0%, #d6eaf8 100%);
            padding: 1.2rem;
            border-radius: 8px;
            margin-top: 2rem;
            border: 1px solid #bee5eb;
        }

        .instructions h4 {
            color: #2c3e50;
            margin-bottom: 0.7rem;
        }

        .instructions ul {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #495057;
            margin-left: 1.2rem;
        }

        .instructions li {
            margin-bottom: 0.3rem;
        }

        /* Animation classes */
        .edge-entering {
            opacity: 0;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        .edge-entered {
            opacity: 1;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 1.5s ease, opacity 0.5s ease;
        }

        .node-entering {
            opacity: 0;
            transform: scale(0.3);
        }

        .node-entered {
            opacity: 1;
            transform: scale(1);
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>Complete Interactive Manuscript Stemma</h1>
            <p>Gregory of Tours - Historiarum Libri Decem | Based on Bruno Krusch's MGH Critical Apparatus</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div class="controls">
                    <h3>Manuscript Families</h3>
                    
                    <div class="family-section">
                        <button class="family-button" data-family="A" style="--family-color: #e74c3c;">
                            <div>
                                <div>Class A - Textus Pleni</div>
                                <div class="family-info">Complete manuscripts</div>
                            </div>
                            <div>
                                <span class="manuscript-count">6</span>
                                <span class="toggle">▶</span>
                            </div>
                        </button>
                    </div>

                    <div class="family-section">
                        <button class="family-button expanded" data-family="B" style="--family-color: #3498db;">
                            <div>
                                <div>Class B - Antiquissimi</div>
                                <div class="family-info">Oldest manuscripts (VII-VIII c.)</div>
                            </div>
                            <div>
                                <span class="manuscript-count">6</span>
                                <span class="toggle">▼</span>
                            </div>
                        </button>
                    </div>

                    <div class="family-section">
                        <button class="family-button" data-family="C" style="--family-color: #2ecc71;">
                            <div>
                                <div>Class C - Mixta</div>
                                <div class="family-info">Derived from B, many variants</div>
                            </div>
                            <div>
                                <span class="manuscript-count">15</span>
                                <span class="toggle">▶</span>
                            </div>
                        </button>
                    </div>

                    <div class="family-section">
                        <button class="family-button" data-family="D" style="--family-color: #f39c12;">
                            <div>
                                <div>Class D - Recentiores</div>
                                <div class="family-info">Later manuscripts with lacunae</div>
                            </div>
                            <div>
                                <span class="manuscript-count">18</span>
                                <span class="toggle">▶</span>
                            </div>
                        </button>
                    </div>

                    <div class="family-section">
                        <button class="family-button" data-family="E" style="--family-color: #9b59b6;">
                            <div>
                                <div>Class E - Fragmenta</div>
                                <div class="family-info">Fragments and excerpts</div>
                            </div>
                            <div>
                                <span class="manuscript-count">12</span>
                                <span class="toggle">▶</span>
                            </div>
                        </button>
                    </div>

                    <div class="family-section">
                        <button class="family-button" data-family="F" style="--family-color: #e67e22;">
                            <div>
                                <div>Class F - Homiliarum</div>
                                <div class="family-info">Homily collections</div>
                            </div>
                            <div>
                                <span class="manuscript-count">2</span>
                                <span class="toggle">▶</span>
                            </div>
                        </button>
                    </div>

                    <div class="legend">
                        <h4>Legend</h4>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #95a5a6;"></div>
                            <span>Archetype</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e74c3c;"></div>
                            <span>Class A (Complete)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3498db;"></div>
                            <span>Class B (Oldest)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2ecc71;"></div>
                            <span>Class C (Mixed)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f39c12;"></div>
                            <span>Class D (Later)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #9b59b6;"></div>
                            <span>Class E (Fragments)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e67e22;"></div>
                            <span>Class F (Homilies)</span>
                        </div>
                    </div>

                    <div class="instructions">
                        <h4>Instructions</h4>
                        <ul>
                            <li>Click family buttons to expand/collapse manuscripts</li>
                            <li>Click nodes for detailed manuscript information</li>
                            <li>Watch edges animate as families expand</li>
                            <li>Drag to pan, scroll to zoom the stemma</li>
                            <li>Line styles show relationship types and confidence</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="main">
                <svg id="stemma-svg"></svg>
                <div class="node-info" id="node-info">
                    <h4 id="node-title"></h4>
                    <div id="node-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete Gregory of Tours stemma data from Krusch MGH
        const stemmaData = {
            families: {
                'A': { 
                    label: 'Class A - Textus Pleni', 
                    color: '#e74c3c', 
                    notes: 'Complete manuscripts containing the full text of Gregory\'s Histories',
                    description: 'The textus pleni represent the most complete tradition of Gregory\'s work. While later in date than Class B, they preserve the full text including passages missing from the older manuscripts. Class A derives from an integral archetype (α) that preserved Gregory\'s complete work.',
                    characteristics: [
                        'Contains all ten books of the Histories',
                        'Preserves passages missing in Class B',
                        'Generally later in date (8th-11th centuries)',
                        'Derives from complete archetype (α)',
                        'Important for textual reconstruction'
                    ]
                },
                'B': { 
                    label: 'Class B - Antiquissimi', 
                    color: '#3498db', 
                    notes: 'Oldest manuscripts (VII-VIII c.) but incomplete, missing many chapters',
                    description: 'The antiquissimi are the oldest surviving manuscripts of Gregory\'s Histories, dating to the 7th-8th centuries. However, they suffer from significant lacunae and contain only books I-VI in their original form, with books VII-X added later. Despite their age, they cannot be considered Gregory\'s original edition.',
                    characteristics: [
                        'Oldest surviving manuscripts (late 7th-8th century)',
                        'Originally contained only books I-VI',
                        'Books VII-X added later (ca. 750 CE)',
                        'Significant lacunae and omissions',
                        'Most important: B1 (Cambrai 624), B2 (Brussels 9403)',
                        'Crucial for paleographic and orthographic evidence'
                    ]
                },
                'C': { 
                    label: 'Class C - Mixta', 
                    color: '#2ecc71', 
                    notes: 'Derived from B-like exemplar, shows contamination between traditions',
                    description: 'Class C manuscripts derive from a B-like exemplar but show extensive contamination and correction from other sources. They can be divided into two subfamilies with different characteristics. Some C manuscripts preserve better readings than their exemplars.',
                    characteristics: [
                        'Derives from B-like exemplar',
                        'Two distinct subfamilies (C1 group vs C2-4 group)',
                        'Shows contamination from Class D',
                        'C2 often preserves excellent readings',
                        'Contains Fredegar continuation in some witnesses',
                        'Important for understanding textual transmission'
                    ]
                },
                'D': { 
                    label: 'Class D - Recentiores', 
                    color: '#f39c12', 
                    notes: 'Later manuscripts with various lacunae and corruptions',
                    description: 'Class D represents later manuscripts that preserve an independent tradition. While generally inferior, some D manuscripts like D1 and the lost D* preserve valuable readings. They typically lack the first preface and show consistent lacunae.',
                    characteristics: [
                        'Independent tradition from the archetype',
                        'Missing first preface and chapter index',
                        'Consistent lacunae in books IV, VI-VIII',
                        'D1 is the best representative',
                        'Lost manuscript D* influenced Class C',
                        'Some preserve unique authentic readings'
                    ]
                },
                'E': { 
                    label: 'Class E - Fragmenta', 
                    color: '#9b59b6', 
                    notes: 'Fragments and excerpts, often in specialized collections',
                    description: 'Class E comprises fragments and excerpts of Gregory\'s work, often preserved in specialized collections, homiliaries, or as separate chapters. These witnesses, while incomplete, sometimes preserve valuable readings and show how Gregory\'s text was used in medieval scholarly contexts.',
                    characteristics: [
                        'Fragmentary preservation',
                        'Often in liturgical or homiletical contexts',
                        'Contains individual chapters (esp. I.48, II.1, X.31)',
                        'Some from very early periods',
                        'Valuable for specific textual problems',
                        'Shows medieval reception of Gregory'
                    ]
                },
                'F': { 
                    label: 'Class F - Homiliarum', 
                    color: '#e67e22', 
                    notes: 'Homily collections containing selected Gregory chapters',
                    description: 'Class F represents manuscripts that preserve Gregory\'s text within homily collections. These manuscripts select specific chapters of theological or moral interest and often show textual modifications for liturgical use.',
                    characteristics: [
                        'Preserved in homily collections',
                        'Selective textual excerpts',
                        'Modified for liturgical use',
                        'Often late in date but preserving early readings',
                        'Important for understanding medieval reception'
                    ]
                }
            },
            witnesses: {
                // Class A - Textus Pleni
                'A1': {
                    id: 'A1', siglum: 'A1', family: 'A',
                    shelfmark: 'Monte Cassino 275',
                    century: 'XI', place: 'Monte Cassino',
                    coverage: 'I-X (nearly complete, some lacunae)',
                    script: 'Beneventan minuscule',
                    notes: 'Only nearly complete surviving manuscript. Commissioned by Abbot Desiderius (1058-1087), later Pope Victor III. Multiple scribes, some significant omissions.',
                    mghPage: 'XXIII-XXIV'
                },
                'A2_Copenhagen': {
                    id: 'A2_Copenhagen', siglum: 'A2 (Copenhagen)', family: 'A',
                    shelfmark: 'Copenhagen Ny Kgl. Saml. 1878 fol.',
                    century: 'VIII in.', place: 'Gaul',
                    coverage: 'V,1-3 (single folio)',
                    script: 'uncial',
                    notes: 'Ancient fragment discovered in book binding. Contains V,1-3. Part of very early A tradition.',
                    mghPage: 'XXIV'
                },
                'A2_Leiden': {
                    id: 'A2_Leiden', siglum: 'A2 (Leiden)', family: 'A',
                    shelfmark: 'Leiden Univ. Lat. fragm. 21',
                    century: 'VIII in.', place: 'Saint-Maximin, Metz',
                    coverage: 'V,43-47 (two folios)',
                    script: 'uncial',
                    notes: 'Fragments prefixed to Hegesippus. Originally from Petau collection. Shows early A text type.',
                    mghPage: 'XXIV'
                },
                'A2_Vatican': {
                    id: 'A2_Vatican', siglum: 'A2 (Vatican)', family: 'A',
                    shelfmark: 'Vatican Reg. Lat. 689',
                    century: 'VIII in.', place: 'Unknown',
                    coverage: 'IX,27-37 (fragmentary)',
                    script: 'uncial',
                    notes: 'Fragmentary folios with parts cut away. Important for chapter numbering corrections.',
                    mghPage: 'XXIV'
                },
                'A3': {
                    id: 'A3', siglum: 'A3', family: 'A',
                    shelfmark: 'Paris Lat. 1451',
                    century: 'IX', place: 'Fossatum monastery',
                    coverage: 'V,43-44; VI,5; VI,40 (theological excerpts)',
                    script: 'Carolingian minuscule',
                    notes: 'Contains canonical collection. Preserves correct chapter numbering. Theological excerpts only.',
                    mghPage: 'XXIV'
                },
                'A4': {
                    id: 'A4', siglum: 'A4', family: 'A',
                    shelfmark: 'Verona Capitular 50',
                    century: 'ca. 800', place: 'Burgundy',
                    coverage: 'I,21; I,23 (Easter homilies)',
                    script: 'minuscule',
                    notes: 'Contains Easter homilies from Gregory. Part of pontifical collection.',
                    mghPage: 'XXV'
                },

                // Class B - Antiquissimi
                'B1': {
                    id: 'B1', siglum: 'B1', family: 'B',
                    shelfmark: 'Cambrai 624',
                    century: 'VII ex.', place: 'Cambrai',
                    coverage: 'I-VI (original), VII-X (8th c. supplement)',
                    script: 'uncial + semi-uncial supplement',
                    notes: 'Oldest manuscript of Gregory. Written by two scribes for books I-VI, supplemented ca. 750. Most important witness.',
                    mghPage: 'XXV-XXVI'
                },
                'B2': {
                    id: 'B2', siglum: 'B2', family: 'B',
                    shelfmark: 'Brussels 9403',
                    century: 'VII ex.', place: 'Unknown',
                    coverage: 'II,3-X (beginning lost)',
                    script: 'minuscule mixed with semi-uncial',
                    notes: 'Similar to B1 but inferior scribal practices. Multiple scribes with varying accuracy. Some folios transposed in exemplar.',
                    mghPage: 'XXVI'
                },
                'B3': {
                    id: 'B3', siglum: 'B3', family: 'B',
                    shelfmark: 'Leiden Voss. Lat. 63',
                    century: 'VIII', place: 'Unknown',
                    coverage: 'II,9-V,26 (fragmentary)',
                    script: 'minuscule with Merovingian cursive',
                    notes: 'Badly preserved, affected by decay. Missing beginning and end quaternions.',
                    mghPage: 'XXVI'
                },
                'B4': {
                    id: 'B4', siglum: 'B4', family: 'B',
                    shelfmark: 'Paris BnF 17654',
                    century: 'VII ex.', place: 'Beauvais',
                    coverage: 'II,3-V,22 (fragmentary)',
                    script: 'uncial',
                    notes: 'Originally from Saint-Pierre de Beauvais. Severely damaged by decay. Missing many quaternions.',
                    mghPage: 'XXVI-XXVII'
                },
                'B5': {
                    id: 'B5', siglum: 'B5', family: 'B',
                    shelfmark: 'Paris BnF 17655',
                    century: 'ca. 700', place: 'Luxeuil',
                    coverage: 'I-VI (complete for B class)',
                    script: 'uncial (Luxeuil style)',
                    notes: 'Worst manuscript of class B. From Corbie monastery. Multiple scribes. Contains duplicate text passages.',
                    mghPage: 'XXVII'
                },
                'B6': {
                    id: 'B6', siglum: 'B6', family: 'B',
                    shelfmark: 'Reichenau fragment (Karlsruhe 104)',
                    century: 'VIII in.', place: 'Reichenau',
                    coverage: 'I,17-19 (single folio)',
                    script: 'uncial',
                    notes: 'Only surviving fragment from Reichenau monastery. Two-volume work mentioned in medieval catalog. Lost except this fragment.',
                    mghPage: 'XXVII'
                },

                // Class C - Major witnesses (sampling the most important)
                'C1': {
                    id: 'C1', siglum: 'C1', family: 'C',
                    shelfmark: 'Heidelberg Pal. Lat. 864',
                    century: 'IX', place: 'Lorsch',
                    coverage: 'I-X (with lacunae and later supplements)',
                    script: 'Carolingian minuscule',
                    notes: 'From Lorsch monastery. Missing chapters supplied in 10th century. Multiple correcting hands. Important for Fredegar continuation.',
                    mghPage: 'XXVII-XXVIII'
                },
                'C2': {
                    id: 'C2', siglum: 'C2', family: 'C',
                    shelfmark: 'Namur 11',
                    century: 'X', place: 'Saint-Hubert',
                    coverage: 'I-X (includes Fredegar continuation)',
                    script: 'Carolingian minuscule',
                    notes: 'Often preserves correct readings superior to other manuscripts. Accurate royal names. Best of class C.',
                    mghPage: 'XXVIII'
                },
                'C3': {
                    id: 'C3', siglum: 'C3', family: 'C',
                    shelfmark: 'Paris Lat. 9765',
                    century: 'X', place: 'Unknown',
                    coverage: 'I-X (with lacunae supplied later)',
                    script: 'Carolingian minuscule',
                    notes: 'Written by multiple scribes. Lacunae supplied by later hands. Part of complex C tradition.',
                    mghPage: 'XXVIII'
                },
                'C4': {
                    id: 'C4', siglum: 'C4', family: 'C',
                    shelfmark: 'Saint-Omer 706',
                    century: 'X', place: 'Saint-Bertin',
                    coverage: 'I-X plus Fredegar and Annals',
                    script: 'Carolingian minuscule',
                    notes: 'Contains Gregory with Fredegar continuation and Bertinian Annals. Shows interpolations from Liber Historiae Francorum.',
                    mghPage: 'XXIX'
                },

                // Class D - Major witnesses
                'D1': {
                    id: 'D1', siglum: 'D1', family: 'D',
                    shelfmark: 'Clermont-Ferrand 261',
                    century: 'XII', place: 'Saint-Allyre, Clermont',
                    coverage: 'I-X (with quaternion losses)',
                    script: 'minuscule',
                    notes: 'Best manuscript of class D. Missing quaternions II,42-IV,18 and VI,40-VIII,1. Preserves some excellent readings.',
                    mghPage: 'XXX'
                },
                'D2': {
                    id: 'D2', siglum: 'D2', family: 'D',
                    shelfmark: 'Vatican Reg. Lat. 556',
                    century: 'XI in.', place: 'Saint-Laumer, Blois',
                    coverage: 'I-X (incomplete at end)',
                    script: 'minuscule',
                    notes: 'Multiple scribes, each assigned individual quaternions. Ends incomplete at X,31. Shows typical D lacunae.',
                    mghPage: 'XXX-XXXI'
                },
                'D3': {
                    id: 'D3', siglum: 'D3', family: 'D',
                    shelfmark: 'Leiden Voss. fol. 39 + Paris Lat. 5920',
                    century: 'XI', place: 'Saint-Mihiel',
                    coverage: 'I-X (bipartite manuscript)',
                    script: 'minuscule',
                    notes: 'Originally one manuscript, now split between Leiden and Paris. Often agrees with B2. Contains Ado\'s Chronicle.',
                    mghPage: 'XXXI'
                },
                'D4': {
                    id: 'D4', siglum: 'D4', family: 'D',
                    shelfmark: 'Vatican Reg. Lat. 1056',
                    century: 'X in.', place: 'Unknown',
                    coverage: 'I-X (text disturbed by misbound folios)',
                    script: 'minuscule',
                    notes: 'Text disrupted by misbound folios in exemplar. Often superior to D3. Preserves unique authentic forms.',
                    mghPage: 'XXXI-XXXII'
                },

                // Class E - Fragments (selection of major ones)
                'E1a': {
                    id: 'E1a', siglum: 'E1a', family: 'E',
                    shelfmark: 'Paris Lat. 10848',
                    century: 'IX', place: 'Tours',
                    coverage: 'I,48; II,1; X,31 + Tours episcopal catalog',
                    script: 'Carolingian minuscule',
                    notes: 'Touronian origin. Contains description of St. Martin\'s basilica and episcopal catalog to 835.',
                    mghPage: 'XXXIII'
                },
                'E2a': {
                    id: 'E2a', siglum: 'E2a', family: 'E',
                    shelfmark: 'Leiden Voss. 12',
                    century: 'IX', place: 'Séez',
                    coverage: 'X,31; I,30',
                    script: 'Carolingian minuscule',
                    notes: 'Fragment from Saint-Martin de Séez. Shows Tours connection through episcopal catalog.',
                    mghPage: 'XXXIII'
                },

                // Class F - Homily collections
                'F1': {
                    id: 'F1', siglum: 'F1', family: 'F',
                    shelfmark: 'Laon 121',
                    century: 'IX', place: 'Unknown',
                    coverage: 'I,47; VI,29; X,1; VII,1; X,24 (miracle excerpts)',
                    script: 'Carolingian minuscule',
                    notes: 'Homily collection with Gregory excerpts on miracles and saints. Theological selection.',
                    mghPage: 'XXXIV-XXXV'
                },
                'F2': {
                    id: 'F2', siglum: 'F2', family: 'F',
                    shelfmark: 'Berlin Lat. 307',
                    century: 'IX', place: 'Werden',
                    coverage: 'Same as F1 (miracle excerpts)',
                    script: 'Carolingian minuscule',
                    notes: 'From Saint Ludger monastery at Werden. Contains same miracle excerpts as F1.',
                    mghPage: 'XXXV'
                }
            },
            edges: [
                // Archetype to main families
                { from: 'archetype', to: 'A_family', type: 'copy', confidence: 0.9 },
                { from: 'archetype', to: 'B_family', type: 'copy', confidence: 0.8 },
                { from: 'archetype', to: 'D_family', type: 'inferred', confidence: 0.6 },
                
                // B family relationships
                { from: 'B_family', to: 'C_family', type: 'copy', confidence: 0.8 },
                
                // Individual manuscript relationships
                { from: 'A_family', to: 'A1', type: 'copy', confidence: 0.8 },
                { from: 'A_family', to: 'A2_Copenhagen', type: 'copy', confidence: 0.9 },
                { from: 'A_family', to: 'A2_Leiden', type: 'copy', confidence: 0.9 },
                { from: 'A_family', to: 'A2_Vatican', type: 'copy', confidence: 0.9 },
                { from: 'A_family', to: 'A3', type: 'copy', confidence: 0.8 },
                { from: 'A_family', to: 'A4', type: 'copy', confidence: 0.8 },
                
                { from: 'B_family', to: 'B1', type: 'copy', confidence: 0.9 },
                { from: 'B_family', to: 'B2', type: 'copy', confidence: 0.8 },
                { from: 'B_family', to: 'B3', type: 'copy', confidence: 0.6 },
                { from: 'B_family', to: 'B4', type: 'copy', confidence: 0.7 },
                { from: 'B_family', to: 'B5', type: 'copy', confidence: 0.5 },
                { from: 'B_family', to: 'B6', type: 'copy', confidence: 0.7 },
                
                { from: 'C_family', to: 'C1', type: 'copy', confidence: 0.8 },
                { from: 'C_family', to: 'C2', type: 'copy', confidence: 0.8 },
                { from: 'C_family', to: 'C3', type: 'copy', confidence: 0.7 },
                { from: 'C_family', to: 'C4', type: 'copy', confidence: 0.7 },
                
                { from: 'D_family', to: 'D1', type: 'copy', confidence: 0.8 },
                { from: 'D_family', to: 'D2', type: 'copy', confidence: 0.7 },
                { from: 'D_family', to: 'D3', type: 'copy', confidence: 0.7 },
                { from: 'D_family', to: 'D4', type: 'copy', confidence: 0.8 },
                
                { from: 'archetype', to: 'E_family', type: 'copy', confidence: 0.5 },
                { from: 'E_family', to: 'E1a', type: 'copy', confidence: 0.7 },
                { from: 'E_family', to: 'E2a', type: 'copy', confidence: 0.6 },
                
                { from: 'archetype', to: 'F_family', type: 'copy', confidence: 0.5 },
                { from: 'F_family', to: 'F1', type: 'copy', confidence: 0.6 },
                { from: 'F_family', to: 'F2', type: 'copy', confidence: 0.6 },
                
                // Cross-contamination
                { from: 'D1', to: 'C2', type: 'contamination', confidence: 0.7 },
                { from: 'B2', to: 'D3', type: 'contamination', confidence: 0.6 }
            ]
        };

        // State
        let expandedFamilies = new Set(['B']);
        let selectedNode = null;
        let animationDelay = 0;

        // SVG setup
        const svg = d3.select('#stemma-svg');
        const width = 1400;
        const height = 1000;

        svg.attr('viewBox', `0 0 ${width} ${height}`);
        const g = svg.append('g');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Build nodes based on current state
        function buildNodes() {
            const nodes = [];
            
            // Add archetype
            nodes.push({
                id: 'archetype',
                label: 'Archetype',
                type: 'archetype',
                x: width / 2,
                y: 80
            });

            // Add family nodes
            const familyIds = Object.keys(stemmaData.families);
            familyIds.forEach((familyId, index) => {
                const family = stemmaData.families[familyId];
                nodes.push({
                    id: `${familyId}_family`,
                    label: family.label.split(' - ')[0], // Shortened label for display
                    type: 'family',
                    family: familyId,
                    isExpanded: expandedFamilies.has(familyId),
                    x: 100 + index * 200,
                    y: 250,
                    data: family
                });

                // Add witness nodes if family is expanded
                if (expandedFamilies.has(familyId)) {
                    const familyWitnesses = Object.values(stemmaData.witnesses)
                        .filter(w => w.family === familyId);
                    
                    const cols = Math.ceil(Math.sqrt(familyWitnesses.length));
                    const startX = 50 + index * 200;
                    
                    familyWitnesses.forEach((witness, wIndex) => {
                        const col = wIndex % cols;
                        const row = Math.floor(wIndex / cols);
                        
                        nodes.push({
                            id: witness.id,
                            label: witness.siglum,
                            type: 'witness',
                            family: familyId,
                            data: witness,
                            x: startX + col * 80,
                            y: 400 + row * 60
                        });
                    });
                }
            });

            return nodes;
        }

        // Enhanced render function with animations
        function render(animate = false) {
            const nodes = buildNodes();
            const nodeIds = new Set(nodes.map(n => n.id));
            const edges = stemmaData.edges.filter(e => 
                nodeIds.has(e.from) && nodeIds.has(e.to)
            );

            // Clear previous content
            g.selectAll('*').remove();
            animationDelay = 0;

            // Create links with animation
            const links = g.selectAll('.link')
                .data(edges)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', '#999')
                .attr('stroke-width', d => Math.sqrt(d.confidence * 4))
                .attr('stroke-dasharray', d => {
                    if (d.type === 'contamination') return '8,4';
                    if (d.type === 'inferred') return '12,3';
                    return 'none';
                })
                .attr('opacity', 0.7)
                .attr('x1', d => {
                    const sourceNode = nodes.find(n => n.id === d.from);
                    return sourceNode ? sourceNode.x : 0;
                })
                .attr('y1', d => {
                    const sourceNode = nodes.find(n => n.id === d.from);
                    return sourceNode ? sourceNode.y : 0;
                })
                .attr('x2', d => {
                    const targetNode = nodes.find(n => n.id === d.to);
                    return targetNode ? targetNode.x : 0;
                })
                .attr('y2', d => {
                    const targetNode = nodes.find(n => n.id === d.to);
                    return targetNode ? targetNode.y : 0;
                });

            // Animate edges if requested
            if (animate) {
                links.each(function(d, i) {
                    if (d.from.includes('_family')) {
                        d3.select(this)
                            .classed('edge-entering', true)
                            .transition()
                            .delay(i * 100)
                            .duration(1500)
                            .ease(d3.easeCircleOut)
                            .classed('edge-entering', false)
                            .classed('edge-entered', true);
                    }
                });
            }

            // Create node groups
            const nodeGroups = g.selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x}, ${d.y})`)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    event.stopPropagation();
                    if (d.type === 'family') {
                        toggleFamily(d.family);
                    } else {
                        showNodeInfo(d);
                    }
                });

            // Add circles with animation
            nodeGroups.append('circle')
                .attr('r', d => {
                    if (d.type === 'archetype') return 25;
                    if (d.type === 'family') return d.isExpanded ? 18 : 30;
                    return 14;
                })
                .attr('fill', d => {
                    if (d.type === 'archetype') return '#95a5a6';
                    const familyColor = stemmaData.families[d.family]?.color || '#95a5a6';
                    return familyColor;
                })
                .attr('stroke', d => selectedNode === d.id ? '#000' : '#fff')
                .attr('stroke-width', d => selectedNode === d.id ? 3 : 2)
                .attr('opacity', d => d.type === 'family' && d.isExpanded ? 0.8 : 1)
                .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))');

            // Add labels
            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .style('fill', '#333')
                .style('font-size', d => d.type === 'archetype' ? '14px' : '11px')
                .style('font-weight', d => d.type === 'archetype' ? 'bold' : '600')
                .style('pointer-events', 'none')
                .text(d => d.label);

            // Animate new nodes
            if (animate) {
                nodeGroups.filter(d => d.type === 'witness')
                    .style('opacity', 0)
                    .style('transform', 'scale(0.3)')
                    .transition()
                    .delay((d, i) => 200 + i * 50)
                    .duration(800)
                    .ease(d3.easeBackOut.overshoot(1.2))
                    .style('opacity', 1)
                    .style('transform', 'scale(1)');
            }

            // Add hover effects
            nodeGroups.on('mouseenter', function(event, d) {
                d3.select(this)
                    .select('circle')
                    .transition()
                    .duration(200)
                    .attr('stroke-width', 4)
                    .attr('stroke', '#000')
                    .style('filter', 'drop-shadow(0 4px 8px rgba(0,0,0,0.2))');
            })
            .on('mouseleave', function(event, d) {
                if (selectedNode !== d.id) {
                    d3.select(this)
                        .select('circle')
                        .transition()
                        .duration(200)
                        .attr('stroke-width', 2)
                        .attr('stroke', '#fff')
                        .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))');
                }
            });
        }

        // Enhanced toggle family with animation
        function toggleFamily(familyId) {
            const wasExpanded = expandedFamilies.has(familyId);
            
            if (wasExpanded) {
                expandedFamilies.delete(familyId);
            } else {
                expandedFamilies.add(familyId);
            }
            
            updateFamilyButtons();
            render(!wasExpanded); // Animate when expanding
        }

        // Update family button states
        function updateFamilyButtons() {
            document.querySelectorAll('.family-button').forEach(button => {
                const familyId = button.dataset.family;
                const toggle = button.querySelector('.toggle');
                if (expandedFamilies.has(familyId)) {
                    button.classList.add('expanded');
                    toggle.textContent = '▼';
                } else {
                    button.classList.remove('expanded');
                    toggle.textContent = '▶';
                }
            });
        }

        // Enhanced node information display
        function showNodeInfo(node) {
            const infoPanel = document.getElementById('node-info');
            const title = document.getElementById('node-title');
            const details = document.getElementById('node-details');

            if (node.type === 'witness' && node.data) {
                const witness = node.data;
                title.textContent = `${witness.siglum} - ${witness.shelfmark}`;
                
                details.innerHTML = `
                    <div class="info-section">
                        <h5>Manuscript Details</h5>
                        <p><strong>Century:</strong> ${witness.century}</p>
                        <p><strong>Place:</strong> ${witness.place}</p>
                        <p><strong>Script:</strong> ${witness.script}</p>
                        <p><strong>Coverage:</strong> ${witness.coverage}</p>
                    </div>
                    
                    <div class="info-section">
                        <h5>Scholarly Notes</h5>
                        <p>${witness.notes}</p>
                    </div>
                    
                    <div class="info-section">
                        <h5>MGH Reference</h5>
                        <p>Page ${witness.mghPage}</p>
                    </div>
                `;
            } else if (node.type === 'family') {
                const family = stemmaData.families[node.family];
                const familyWitnesses = Object.values(stemmaData.witnesses)
                    .filter(w => w.family === node.family);
                
                title.textContent = family.label;
                
                details.innerHTML = `
                    <div class="info-section">
                        <h5>Family Description</h5>
                        <p>${family.description}</p>
                    </div>
                    
                    <div class="info-section">
                        <h5>Key Characteristics</h5>
                        <ul>${family.characteristics.map(char => `<li>${char}</li>`).join('')}</ul>
                    </div>
                    
                    <div class="info-section">
                        <h5>Manuscripts in this Family</h5>
                        <div class="manuscript-list">
                            ${familyWitnesses.map(w => `
                                <div class="manuscript-item" style="--family-color: ${family.color}">
                                    <div class="manuscript-siglum">${w.siglum}</div>
                                    <div class="manuscript-details">${w.shelfmark} (${w.century})</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                title.textContent = 'Archetype';
                details.innerHTML = `
                    <div class="info-section">
                        <h5>The Lost Original</h5>
                        <p>The archetype represents Gregory's original manuscript of the <em>Historiae</em>, completed around 593-594 CE. No direct copies survive, but its text can be reconstructed through comparison of the various manuscript families.</p>
                    </div>
                    
                    <div class="info-section">
                        <h5>Textual Tradition</h5>
                        <p>All surviving manuscripts derive from this lost archetype through various intermediate copies. The oldest witnesses (Class B) preserve Gregory's orthography but lack many passages, while later complete texts (Class A) preserve the full work but with normalized spelling.</p>
                    </div>
                `;
            }

            selectedNode = node.id;
            infoPanel.style.display = 'block';
            render();
        }

        // Event listeners
        document.querySelectorAll('.family-button').forEach(button => {
            button.addEventListener('click', () => {
                const familyId = button.dataset.family;
                toggleFamily(familyId);
            });
        });

        // Close info panel when clicking background
        svg.on('click', () => {
            document.getElementById('node-info').style.display = 'none';
            selectedNode = null;
            render();
        });

        // Initial render
        updateFamilyButtons();
        render();

        console.log('Complete Gregory of Tours stemma loaded with', 
            Object.keys(stemmaData.witnesses).length, 'manuscripts!');
    </script>
</body>
</html>