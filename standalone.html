<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Manuscript Stemma - Gregory of Tours</title>
    <script src="https://unpkg.com/d3@7"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f9fa;
        }

        .app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.8;
        }

        .content {
            flex: 1;
            display: flex;
            height: calc(100vh - 100px);
        }

        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #dee2e6;
            padding: 1rem;
            overflow-y: auto;
        }

        .main {
            flex: 1;
            position: relative;
        }

        .controls h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group h4 {
            color: #34495e;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .family-button {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
        }

        .family-button.expanded {
            background: #3498db;
            color: white;
        }

        .family-button:hover {
            border-color: #3498db;
        }

        .legend {
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #ccc;
        }

        .node-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            display: none;
        }

        .node-info h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .node-info p {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        #stemma-svg {
            width: 100%;
            height: 100%;
            background: #fafafa;
            border: 1px solid #ddd;
        }

        .instructions {
            background: #e8f4f8;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .instructions ul {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #666;
            margin-left: 1rem;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>Interactive Manuscript Stemma</h1>
            <p>Gregory of Tours - Historiarum Libri Decem</p>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div class="controls">
                    <h3>Manuscript Families</h3>
                    
                    <div class="control-group">
                        <h4>Expand/Collapse Families</h4>
                        <button class="family-button" data-family="A">
                            <span class="toggle">▶</span> Class A (Complete manuscripts)
                        </button>
                        <button class="family-button expanded" data-family="B">
                            <span class="toggle">▼</span> Class B (Oldest manuscripts)
                        </button>
                        <button class="family-button" data-family="C">
                            <span class="toggle">▶</span> Class C (Derived from B)
                        </button>
                        <button class="family-button" data-family="D">
                            <span class="toggle">▶</span> Class D (Later manuscripts)
                        </button>
                    </div>

                    <div class="legend">
                        <h4>Legend</h4>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #95a5a6;"></div>
                            <span>Archetype</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e74c3c;"></div>
                            <span>Class A (Complete)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3498db;"></div>
                            <span>Class B (Oldest)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #2ecc71;"></div>
                            <span>Class C</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #f39c12;"></div>
                            <span>Class D</span>
                        </div>
                    </div>

                    <div class="instructions">
                        <h4>Instructions</h4>
                        <ul>
                            <li>Click family buttons to expand/collapse</li>
                            <li>Click nodes for manuscript details</li>
                            <li>Drag to pan, scroll to zoom</li>
                            <li>Line style shows relationship type</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="main">
                <svg id="stemma-svg"></svg>
                <div class="node-info" id="node-info">
                    <h4 id="node-title"></h4>
                    <div id="node-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gregory of Tours stemma data
        const stemmaData = {
            families: {
                'A': { label: 'Class A', color: '#e74c3c', notes: 'Complete manuscripts' },
                'B': { label: 'Class B', color: '#3498db', notes: 'Oldest manuscripts (VII-VIII c.)' },
                'C': { label: 'Class C', color: '#2ecc71', notes: 'Derived from B-like exemplar' },
                'D': { label: 'Class D', color: '#f39c12', notes: 'Later manuscripts' }
            },
            witnesses: {
                // Class A
                'A1': {
                    id: 'A1', siglum: 'A1', family: 'A',
                    shelfmark: 'Monte Cassino 275',
                    century: 'XI', place: 'Monte Cassino',
                    coverage: 'I-X (nearly complete)',
                    script: 'Beneventan minuscule',
                    notes: 'Commissioned by Abbot Desiderius (1058-1087)'
                },
                // Class B
                'B1': {
                    id: 'B1', siglum: 'B1', family: 'B',
                    shelfmark: 'Cambrai 624',
                    century: 'VII ex.', place: 'Cambrai',
                    coverage: 'I-VI (original), VII-X (supplement)',
                    script: 'uncial + semi-uncial',
                    notes: 'Oldest manuscript of Gregory, two scribes'
                },
                'B2': {
                    id: 'B2', siglum: 'B2', family: 'B',
                    shelfmark: 'Brussels 9403',
                    century: 'VII ex.', place: 'Unknown',
                    coverage: 'II,3-X (beginning lost)',
                    script: 'minuscule mixed with semi-uncial',
                    notes: 'Similar to B1 but worse scribal practices'
                },
                'B3': {
                    id: 'B3', siglum: 'B3', family: 'B',
                    shelfmark: 'Leiden Voss. Lat. 63',
                    century: 'VIII', place: 'Unknown',
                    coverage: 'II,9-V,26 (fragmentary)',
                    script: 'minuscule with Merovingian cursive',
                    notes: 'Badly preserved, affected by decay'
                },
                // Class C
                'C1': {
                    id: 'C1', siglum: 'C1', family: 'C',
                    shelfmark: 'Heidelberg Pal. Lat. 864',
                    century: 'IX', place: 'Lorsch',
                    coverage: 'I-X (with lacunae)',
                    script: 'Carolingian minuscule',
                    notes: 'From Lorsch monastery, multiple correcting hands'
                },
                'C2': {
                    id: 'C2', siglum: 'C2', family: 'C',
                    shelfmark: 'Namur 11',
                    century: 'X', place: 'Saint-Hubert',
                    coverage: 'I-X (includes Fredegar continuation)',
                    script: 'Carolingian minuscule',
                    notes: 'Often preserves correct readings'
                },
                // Class D
                'D1': {
                    id: 'D1', siglum: 'D1', family: 'D',
                    shelfmark: 'Unknown',
                    century: 'IX-X', place: 'Unknown',
                    coverage: 'I-X',
                    script: 'minuscule',
                    notes: 'Best manuscript of class D'
                }
            },
            edges: [
                { from: 'archetype', to: 'A_family', type: 'copy' },
                { from: 'archetype', to: 'B_family', type: 'copy' },
                { from: 'B_family', to: 'C_family', type: 'copy' },
                { from: 'archetype', to: 'D_family', type: 'inferred' },
                { from: 'A_family', to: 'A1', type: 'copy' },
                { from: 'B_family', to: 'B1', type: 'copy' },
                { from: 'B_family', to: 'B2', type: 'copy' },
                { from: 'B_family', to: 'B3', type: 'copy' },
                { from: 'C_family', to: 'C1', type: 'copy' },
                { from: 'C_family', to: 'C2', type: 'copy' },
                { from: 'D_family', to: 'D1', type: 'copy' },
                { from: 'D1', to: 'C2', type: 'contamination' }
            ]
        };

        // State
        let expandedFamilies = new Set(['B']);
        let selectedNode = null;

        // SVG setup
        const svg = d3.select('#stemma-svg');
        const width = 800;
        const height = 600;

        svg.attr('viewBox', `0 0 ${width} ${height}`);

        const g = svg.append('g');

        // Zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Build nodes based on current state
        function buildNodes() {
            const nodes = [];
            
            // Add archetype
            nodes.push({
                id: 'archetype',
                label: 'Archetype',
                type: 'archetype',
                x: width / 2,
                y: 100
            });

            // Add family nodes
            Object.keys(stemmaData.families).forEach((familyId, index) => {
                const family = stemmaData.families[familyId];
                nodes.push({
                    id: `${familyId}_family`,
                    label: family.label,
                    type: 'family',
                    family: familyId,
                    isExpanded: expandedFamilies.has(familyId),
                    x: 150 + index * 150,
                    y: 250
                });

                // Add witness nodes if family is expanded
                if (expandedFamilies.has(familyId)) {
                    const familyWitnesses = Object.values(stemmaData.witnesses)
                        .filter(w => w.family === familyId);
                    
                    familyWitnesses.forEach((witness, wIndex) => {
                        nodes.push({
                            id: witness.id,
                            label: witness.siglum,
                            type: 'witness',
                            family: familyId,
                            data: witness,
                            x: 100 + index * 150 + (wIndex * 60),
                            y: 400
                        });
                    });
                }
            });

            return nodes;
        }

        // Render function
        function render() {
            const nodes = buildNodes();
            const nodeIds = new Set(nodes.map(n => n.id));
            const edges = stemmaData.edges.filter(e => 
                nodeIds.has(e.from) && nodeIds.has(e.to)
            );

            // Clear previous content
            g.selectAll('*').remove();

            // Create links
            const links = g.selectAll('.link')
                .data(edges)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('stroke', '#999')
                .attr('stroke-width', 2)
                .attr('stroke-dasharray', d => {
                    if (d.type === 'contamination') return '5,5';
                    if (d.type === 'inferred') return '10,3';
                    return 'none';
                })
                .attr('x1', d => {
                    const sourceNode = nodes.find(n => n.id === d.from);
                    return sourceNode ? sourceNode.x : 0;
                })
                .attr('y1', d => {
                    const sourceNode = nodes.find(n => n.id === d.from);
                    return sourceNode ? sourceNode.y : 0;
                })
                .attr('x2', d => {
                    const targetNode = nodes.find(n => n.id === d.to);
                    return targetNode ? targetNode.x : 0;
                })
                .attr('y2', d => {
                    const targetNode = nodes.find(n => n.id === d.to);
                    return targetNode ? targetNode.y : 0;
                });

            // Create node groups
            const nodeGroups = g.selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x}, ${d.y})`)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    event.stopPropagation();
                    if (d.type === 'family') {
                        toggleFamily(d.family);
                    } else {
                        showNodeInfo(d);
                    }
                });

            // Add circles
            nodeGroups.append('circle')
                .attr('r', d => {
                    if (d.type === 'archetype') return 20;
                    if (d.type === 'family') return d.isExpanded ? 15 : 25;
                    return 12;
                })
                .attr('fill', d => {
                    if (d.type === 'archetype') return '#95a5a6';
                    const familyColor = stemmaData.families[d.family]?.color || '#95a5a6';
                    return familyColor;
                })
                .attr('stroke', d => selectedNode === d.id ? '#000' : '#fff')
                .attr('stroke-width', d => selectedNode === d.id ? 3 : 2)
                .attr('opacity', d => d.type === 'family' && d.isExpanded ? 0.7 : 1);

            // Add labels
            nodeGroups.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '.35em')
                .style('fill', '#333')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .style('pointer-events', 'none')
                .text(d => d.label);
        }

        // Toggle family expansion
        function toggleFamily(familyId) {
            if (expandedFamilies.has(familyId)) {
                expandedFamilies.delete(familyId);
            } else {
                expandedFamilies.add(familyId);
            }
            updateFamilyButtons();
            render();
        }

        // Update family button states
        function updateFamilyButtons() {
            document.querySelectorAll('.family-button').forEach(button => {
                const familyId = button.dataset.family;
                const toggle = button.querySelector('.toggle');
                if (expandedFamilies.has(familyId)) {
                    button.classList.add('expanded');
                    toggle.textContent = '▼';
                } else {
                    button.classList.remove('expanded');
                    toggle.textContent = '▶';
                }
            });
        }

        // Show node information
        function showNodeInfo(node) {
            const infoPanel = document.getElementById('node-info');
            const title = document.getElementById('node-title');
            const details = document.getElementById('node-details');

            if (node.type === 'witness' && node.data) {
                const witness = node.data;
                title.textContent = witness.siglum;
                details.innerHTML = `
                    <p><strong>Shelfmark:</strong> ${witness.shelfmark}</p>
                    <p><strong>Century:</strong> ${witness.century}</p>
                    <p><strong>Place:</strong> ${witness.place}</p>
                    <p><strong>Coverage:</strong> ${witness.coverage}</p>
                    <p><strong>Script:</strong> ${witness.script}</p>
                    <p><strong>Notes:</strong> ${witness.notes}</p>
                `;
            } else if (node.type === 'family') {
                const family = stemmaData.families[node.family];
                title.textContent = family.label;
                details.innerHTML = `
                    <p>${family.notes}</p>
                    <p><strong>Witnesses:</strong> ${
                        Object.values(stemmaData.witnesses)
                            .filter(w => w.family === node.family)
                            .map(w => w.siglum)
                            .join(', ')
                    }</p>
                `;
            } else {
                title.textContent = 'Archetype';
                details.innerHTML = '<p>Hypothetical original manuscript from which all surviving copies derive.</p>';
            }

            selectedNode = node.id;
            infoPanel.style.display = 'block';
            render();
        }

        // Event listeners
        document.querySelectorAll('.family-button').forEach(button => {
            button.addEventListener('click', () => {
                const familyId = button.dataset.family;
                toggleFamily(familyId);
            });
        });

        // Close info panel when clicking background
        svg.on('click', () => {
            document.getElementById('node-info').style.display = 'none';
            selectedNode = null;
            render();
        });

        // Initial render
        updateFamilyButtons();
        render();

        console.log('Stemma loaded successfully!');
    </script>
</body>
</html>